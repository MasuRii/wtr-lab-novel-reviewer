// ==UserScript==
// @name WTR-Lab Novel Reviewer
// @description Analyzes novels on wtr-lab.com using Gemini AI to provide comprehensive assessments including character development, plot structure, world-building, themes & messages, and writing style.
// @version 1.8.1
// @author MasuRii
// @supportURL https://github.com/MasuRii/wtr-lab-novel-reviewer/issues
// @match https://wtr-lab.com/en/for-you*
// @connect generativelanguage.googleapis.com
// @connect fonts.googleapis.com
// @downloadURL https://raw.githubusercontent.com/MasuRii/wtr-lab-novel-reviewer/main/dist/wtr-lab-novel-reviewer.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @grant GM_xmlhttpRequest
// @grant GM_getResourceText
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://raw.githubusercontent.com/MasuRii/wtr-lab-novel-reviewer/main/dist/wtr-lab-novel-reviewer.user.js
// @website https://github.com/MasuRii/wtr-lab-novel-reviewer
// ==/UserScript==

(()=>{"use strict";const n=["gemini-2.5-pro","gemini-flash-latest","gemini-flash-lite-latest","gemini-2.5-flash","gemini-2.5-flash-lite"],e=1e3,t=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#ff5722","#795548","#607d8b","#8bc34a","#ffc107","#673ab7","#00bcd4","#ff9800","#4caf50","#2196f3","#f44336","#9c27b0"],i="gemini-2.5-flash",o=!1;let a={apiKey:"",batchLimit:5,geminiModel:i,debugLoggingEnabled:o};function r(n){GM_setValue("geminiApiKey",n.apiKey),GM_setValue("batchLimit",n.batchLimit),GM_setValue("geminiModel",n.geminiModel),GM_setValue("debugLoggingEnabled",n.debugLoggingEnabled),a={...n}}function s(){return{...a}}function l(){return a.apiKey}function d(){return a.batchLimit}function c(n){return new Promise(e=>setTimeout(e,n))}function m(n,e){a.debugLoggingEnabled&&console.log(`[WTR-Lab Novel Reviewer Debug] ${n}`,e||"")}const g=new Map;let p=!1;async function u(){m("Building serie_id mapping from __NEXT_DATA__");const n=document.querySelector('script[id="__NEXT_DATA__"]');if(!n)return console.warn("__NEXT_DATA__ script not found. Unable to build serie_id mapping."),!1;try{const e=JSON.parse(n.textContent);return e.props?.pageProps?.list&&e.props.pageProps.list.forEach(n=>{n.raw_id&&n.serie_id&&g.set(n.raw_id.toString(),n.serie_id.toString())}),m(`Built serie_id map with ${g.size} entries`),0!==g.size||(console.error("Serie ID mapping failed: Map is empty after building"),!1)}catch(n){return console.error("Error parsing __NEXT_DATA__:",n),!1}}function f(n,e){return e&&null!=e&&""!==e?/^\d+$/.test(e.toString())?(m(`Mapping validation SUCCESS: raw_id ${n} -> serie_id ${e}`),!0):(m(`Mapping validation FAILED: Invalid serie_id format "${e}" for raw_id ${n}`),!1):(m(`Mapping validation FAILED: Invalid serie_id for raw_id ${n}`),!1)}function y(n){return g.get(n)||null}function h(){if(p)return;p=!0;const n=window.__ICON_REPLACEMENTS__?"material-icons-fallback":"material-icons",e=window.__ICON_REPLACEMENTS__?"‚ö†Ô∏è":"error",t=document.createElement("div");t.id="gemini-mapping-failure-notification",t.innerHTML=`\n\t\t<div class="notification-content">\n\t\t\t<span class="${n} notification-icon">${e}</span>\n\t\t\t<div class="notification-text">\n\t\t\t\t<strong>Serie ID Mapping Failed</strong>\n\t\t\t\t<p>Unable to map novel IDs correctly. Please refresh the page to retry.</p>\n\t\t\t</div>\n\t\t\t<button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>\n\t\t</div>\n\t`,document.body.appendChild(t),console.error("MAPPING FAILURE: User has been notified to refresh the page"),m("Mapping failure notification displayed to user")}function b(){GM_addStyle("\n.material-icons {\n\tfont-style: normal;\n\tfont-weight: normal;\n\tfont-size: 20px;\n\tline-height: 1;\n\tletter-spacing: normal;\n\ttext-transform: none;\n\tdisplay: inline-block;\n\twhite-space: nowrap;\n\tword-wrap: normal;\n\tdirection: ltr;\n\t-webkit-font-smoothing: antialiased;\n\tvertical-align: middle;\n}\n"),window.__ICON_REPLACEMENTS__={auto_awesome:"‚≠ê",assessment:"üìä",expand_more:"‚ñº",error:"‚ö†Ô∏è"}}function w(){try{const n="__localStorage_test__";return localStorage.setItem(n,"test"),localStorage.removeItem(n),!0}catch(n){return!1}}function v(n){return`geminiAssessment_${n}`}function x(n){if(!w())return null;try{const e=v(n),t=localStorage.getItem(e);if(t){const n=JSON.parse(t);if(n&&"object"==typeof n&&n.assessment)return n}}catch(e){console.warn("Error retrieving cached assessment for serieId:",n,e)}return null}const k=new Map;function E(n){const e=new Set;return n.forEach(n=>{if(n.username){const t=n.username.trim();t&&"null"!==t&&"undefined"!==t&&e.add(t)}}),Array.from(e)}function S(n){if(!n)return"";const e=n.toLowerCase();return e.includes("good")||e.includes("excellent")||e.includes("outstanding")||e.includes("very good")||e.includes("strong")?"good":e.includes("mixed")||e.includes("average")||e.includes("decent")||e.includes("fair")||e.includes("moderate")?"mixed":e.includes("bad")||e.includes("poor")||e.includes("weak")||e.includes("lacking")||e.includes("needs improvement")?"bad":e.includes("unknown")||e.includes("missing")||e.includes("unspecified")||e.includes("undetermined")||e.includes("insufficient")?"unknown":""}function _(n,e){if(!(e=function(n){return n.unknown||(n.unknown="Mixed"),n}(e))||!e.assessment||!e.summary)return;const i=e.assessment.toLowerCase();"good"===i?n.classList.add("gemini-good-novel"):"mixed"===i?n.classList.add("gemini-mixed-novel"):"bad"===i&&n.classList.add("gemini-bad-novel");const o=document.createElement("div");o.className="gemini-summary-container";const a=S(e.assessment),r=S(e.characterDevelopment),s=S(e.plotStructure),l=S(e.worldBuilding),d=S(e.themesAndMessages),c=S(e.writingStyle),m=S(e.unknown),g=e.availableUsernames||[],p=window.__ICON_REPLACEMENTS__?{iconClass:"material-icons-fallback",expandIcon:"‚ñº",autoAwesomeIcon:"‚≠ê"}:{iconClass:"material-icons",expandIcon:"expand_more",autoAwesomeIcon:"auto_awesome"};let u="<h4>AI Novel Assessment</h4>";u+='<div class="summary-toggle collapsed" data-target="novel-summary">',u+="<span>Novel Summary</span>",u+=`<span class="${p.iconClass} toggle-icon">${p.expandIcon}</span>`,u+="</div>",u+='<div class="summary-content" id="novel-summary">',u+=`<p>${e.novelSummary}</p>`,u+="</div>";const f=function(n,e){if(!n||!e||0===e.length)return n;let i=n;return[...e].sort((n,e)=>e.length-n.length).forEach(n=>{const e=function(n){if(!n||"null"===n||"undefined"===n||""===n.trim())return"#95a5a6";if(k.has(n))return k.get(n);let e=0;for(let t=0;t<n.length;t++)e=(e<<5)-e+n.charCodeAt(t),e&=e;const i=Math.abs(e)%t.length,o=t[i];return k.set(n,o),o}(n),o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`\\b${o}\\b`,"gi"),r=n&&"null"!==n&&"undefined"!==n&&""!==n.trim()?"username-color-coded":"username-color-coded anonymous";i=i.replace(a,n=>`<span class="${r}" style="color: ${e}; font-weight: 600;">${n}</span>`)}),i}(e.reviewSummary,g);u+='<div class="summary-toggle collapsed" data-target="review-summary">',u+="<span>Review Summary</span>",u+=`<span class="${p.iconClass} toggle-icon">${p.expandIcon}</span>`,u+="</div>",u+='<div class="summary-content" id="review-summary">',u+=`<p>${f}</p>`,u+="</div>",u+='<div class="assessment-section">',u+=`<strong>Overall Assessment:</strong> <span class="assessment-rating ${a}">${e.assessment}</span><br><hr style="margin: 5px 0;">`,u+=`<strong>Analysis Summary:</strong> ${e.summary}<br><hr style="margin: 5px 0;">`,e.characterDevelopment&&(u+=`<strong>Character Development:</strong> <span class="assessment-rating ${r}">${"Unknown"===e.characterDevelopment?"Insufficient Data":e.characterDevelopment}</span><br>`),e.plotStructure&&(u+=`<strong>Plot Structure:</strong> <span class="assessment-rating ${s}">${"Unknown"===e.plotStructure?"Insufficient Data":e.plotStructure}</span><br>`),e.worldBuilding&&(u+=`<strong>World-Building:</strong> <span class="assessment-rating ${l}">${"Unknown"===e.worldBuilding?"Insufficient Data":e.worldBuilding}</span><br>`),e.themesAndMessages&&(u+=`<strong>Themes & Messages:</strong> <span class="assessment-rating ${d}">${"Unknown"===e.themesAndMessages?"Insufficient Data":e.themesAndMessages}</span><br>`),e.writingStyle&&(u+=`<strong>Writing Style:</strong> <span class="assessment-rating ${c}">${"Unknown"===e.writingStyle?"Insufficient Data":e.writingStyle}</span><br>`),e.unknown&&"Mixed"!==e.unknown&&(u+=`<strong>Legacy Unknown Data:</strong> <span class="assessment-rating ${m}">${e.unknown}</span><br>`),u+="</div>",o.innerHTML=`\n\t\t<div class="gemini-summary-trigger" title="Show AI Summary">\n\t\t\t<span class="${p.iconClass}">${p.autoAwesomeIcon}</span>\n\t\t</div>\n\t\t<div class="gemini-summary-card">\n\t\t\t${u}\n\t\t</div>\n\t`;const y=o.querySelector(".gemini-summary-card"),h=o.querySelector(".gemini-summary-trigger"),b=y.querySelectorAll(".summary-toggle");let w=!1;h.addEventListener("click",function(n){n.stopPropagation(),w=!w,w?y.classList.add("locked"):y.classList.remove("locked")}),b.forEach(n=>{n.addEventListener("click",function(){const n=this.dataset.target,e=y.querySelector(`#${n}`);this.classList.contains("collapsed")?(this.classList.remove("collapsed"),e.classList.add("expanded")):(this.classList.add("collapsed"),e.classList.remove("expanded"))})}),n.appendChild(o)}function I(n){return n.unknown||(n.unknown="Mixed"),n}async function A(n){let e=[];const t=`https://wtr-lab.com/api/review/get?serie_id=${n}&page=0&sort=most_liked`;m(`Fetching reviews for serieId ${n}, Page 0 from: ${t}`);try{const i=await fetch(t);if(!i.ok)return m(`Review API response not OK for ${n}. Status: ${i.status}`),[];const o=await i.json();if(m(`Review API raw data for ${n}, Page 0:`,o),!(o.success&&o.data&&o.data.length>0))return m(`No reviews found in page 0 for ${n}`),[];{e=e.concat(o.data),m(`Page 0 received ${o.data.length} reviews for ${n}`);const t=o.data.filter(n=>n.comment);if(t.length>=3)return m(`Page 0 has sufficient data (${t.length} reviews with comments) for ${n} - stopping here`),e}}catch(e){return console.error(`Error fetching reviews for serie_id ${n} on page 0:`,e),[]}for(let t=1;t<5;t++){const i=`https://wtr-lab.com/api/review/get?serie_id=${n}&page=${t}&sort=most_liked`;m(`Fetching reviews for serieId ${n}, Page ${t} from: ${i}`);try{const o=await fetch(i);if(!o.ok){m(`Review API response not OK for ${n}. Status: ${o.status}`);break}const a=await o.json();if(m(`Review API raw data for ${n}, Page ${t}:`,a),!(a.success&&a.data&&a.data.length>0))break;e=e.concat(a.data)}catch(e){console.error(`Error fetching reviews for serie_id ${n} on page ${t}:`,e);break}await c(100)}return e}async function $(n,t){const i=[],o=[];for(let e=0;e<n.length;e++){const a=n[e],r=t[e],s=a.querySelector("a[data-novel-id]");let l=null,d=null;if(s&&(d=s.dataset.novelId,d)){if(l=y(d),!l)throw console.error(`PROCESSING HALTED: No serie_id mapping for raw_id ${d}`),h(),t.forEach(n=>n&&n.remove()),new Error("No serie_id mapping found");if(!f(d,l))throw console.error(`PROCESSING HALTED: Invalid serie_id "${l}" for raw_id ${d}`),h(),t.forEach(n=>n&&n.remove()),new Error("Invalid serie_id mapping detected")}if(!l)throw console.error("PROCESSING HALTED: Unable to obtain valid serie_id"),h(),t.forEach(n=>n&&n.remove()),new Error("No valid serie_id available");const m=a.querySelector("a.title");let g=m?m.textContent.trim():"No title";m&&g.startsWith("#")&&(g=g.split(" ").slice(1).join(" "));const p=m?m.querySelector(".rawtitle"):null;p&&(g=g.replace(p.textContent,"").trim());const u=a.querySelector(".detail-buttons .detail-line:nth-of-type(1)");let b=0;if(u){const n=u.textContent.match(/(\d+) views/);n&&(b=parseInt(n[1],10))}const w=a.querySelector(".detail-buttons .detail-line:nth-of-type(2)");let v=0;if(w){const n=w.textContent.match(/(\d+) Readers/);n&&(v=parseInt(n[1],10))}const x=a.querySelector(".rating-text");let k=0;if(x){const n=x.textContent.match(/(\d+\.\d+)/);n&&(k=parseFloat(n[1]))}const S=a.querySelectorAll(".genres .genre"),_=Array.from(S).map(n=>n.textContent.trim()),I=a.querySelector(".description")?.textContent.trim()||"No description.",$=(await A(l)).filter(n=>n.comment),M=$.map(n=>`- User: ${n.username||"Unknown"}\n- Rating: ${n.rate}/5\n- Comment: ${n.comment}`).join("\n\n"),C=E($);i.push({serieId:l,title:g,totalViews:b,totalReaders:v,rating:k,genres:_,description:I,reviewsText:M,availableUsernames:C}),o.push({card:a,overlay:r,serieId:l}),await c(300)}if(0===i.length)return{batchResults:o,novelsData:[]};const r=await function(n){const t=`\n\t              Analyze the following list of novels. For each novel, use its title, view count, reader count, rating, genres, description, and user reviews to provide a comprehensive assessment across multiple categories.\n\t              Return a single JSON array. Each object in the array must correspond to a novel in the input list, maintaining the original order.\n\n\t              For each novel, provide:\n\t              1. A novel summary: A concise 2-3 sentence summary of what the novel is about, based primarily on the title, description, genres, and user reviews.\n\t              2. A review summary: A balanced summary of user feedback from the reviews, including positive and negative points, with proper attribution to usernames (e.g., "According to [User], ..."). Use EXACT usernames from the availableUsernames list when making attributions.\n\n\t              Then provide detailed assessments in the following categories:\n\t              - Overall assessment (Good/Mixed/Bad)\n\t              - Character Development (Good/Mixed/Bad/Unknown)\n\t              - Plot Structure (Good/Mixed/Bad/Unknown)\n\t              - World-Building (Good/Mixed/Bad/Unknown)\n\t              - Themes & Messages (Good/Mixed/Bad/Unknown)\n\t              - Writing Style (Good/Mixed/Bad/Unknown)\n\n\t              For each category, include specific criteria:\n\t              - Character Development: character depth, growth, consistency, dialogue authenticity, relationship dynamics\n\t              - Plot Structure: pacing, narrative flow, story coherence, conflict resolution, foreshadowing\n\t              - World-Building: setting details, consistency, immersion, cultural depth, originality\n\t              - Themes & Messages: clarity, relevance, integration, thought provocation, balance\n\t              - Writing Style: prose quality, descriptive language, dialogue naturalness, grammar, technical execution\n\n\t              CRITICAL: Each category can be rated as "Unknown" when:\n\t              - Character Development: No character development information found in available data\n\t              - Plot Structure: No plot structure information found in available data\n\t              - World-Building: No world-building details found in available data\n\t              - Themes & Messages: No theme or message information found in available data\n\t              - Writing Style: No writing style information found in available data\n\n\t              Important distinctions:\n\t              - "Unknown" means: insufficient data to make a reliable assessment for that specific aspect\n\t              - "Bad" means: poor quality or problematic implementation of that aspect\n\t              - Use "Unknown" when data is genuinely missing or insufficient, NOT when quality is poor\n\n\t              Novels List:\n\t              ${JSON.stringify(n,null,2)}\n\t      `,i=JSON.stringify({contents:[{parts:[{text:t}]}],generationConfig:{responseMimeType:"application/json",responseJsonSchema:{type:"array",items:{type:"object",properties:{novelSummary:{type:"string",description:"A concise 2-3 sentence summary of what the novel is about."},reviewSummary:{type:"string",description:"A balanced summary of user feedback with proper username attribution."},assessment:{type:"string",enum:["Good","Mixed","Bad"]},summary:{type:"string",description:"A brief 2-3 sentence summary explaining the overall assessment."},characterDevelopment:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},plotStructure:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},worldBuilding:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},themesAndMessages:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},writingStyle:{type:"string",enum:["Good","Mixed","Bad","Unknown"]}},required:["novelSummary","reviewSummary","assessment","summary","characterDevelopment","plotStructure","worldBuilding","themesAndMessages","writingStyle"]}},temperature:.3},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]});return m("Gemini Prompt:",t),new Promise((n,t)=>{let o=0;const r=()=>{const s=l(),d=a.geminiModel;GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/models/${d}:generateContent?key=${s}`,headers:{"Content-Type":"application/json"},data:i,onload:function(i){try{const a=JSON.parse(i.responseText);if(m("Gemini Raw Response:",a),a.candidates&&a.candidates.length>0){const e=JSON.parse(a.candidates[0].content.parts[0].text);n(e)}else{const n=a.promptFeedback?`Gemini block reason: ${JSON.stringify(a.promptFeedback)}`:"Gemini API returned no candidates.";if(console.error("Gemini API Response Error:",a),o<3){o++;const t=e*Math.pow(2,o-1);console.warn(`Retrying Gemini request in ${t}ms (Attempt ${o}/3). Error: ${n}`),setTimeout(r,t)}else t(`Gemini API failed after 3 retries. Last error: ${n}`)}}catch(n){if(o<3){o++;const t=e*Math.pow(2,o-1);console.warn(`Retrying Gemini request in ${t}ms (Attempt ${o}/3). Error: Failed to parse response: ${n}`),setTimeout(r,t)}else t(`Failed to parse Gemini response after 3 retries: ${n}\nResponse: ${i.responseText}`)}},onerror:n=>{if(o<3){o++;const t=e*Math.pow(2,o-1);console.warn(`Retrying Gemini request in ${t}ms (Attempt ${o}/3). Error: API request failed: ${n.statusText}`),setTimeout(r,t)}else t(`Gemini API request failed after 3 retries: ${n.statusText}`)}})};r()})}(i);if(r.length!==i.length)throw new Error("Mismatch between number of novels sent and analyses received.");return o.forEach(({card:n,overlay:e,serieId:t},o)=>{let a=r[o];const s=i[o];a&&(!a.availableUsernames&&s&&s.availableUsernames&&(a.availableUsernames=s.availableUsernames),a=I(a),_(n,a),function(n,e){if(w())try{const t=v(n);localStorage.setItem(t,JSON.stringify(e))}catch(e){"QuotaExceededError"===e.name?console.warn("Local storage quota exceeded, unable to cache assessment for serieId:",n):console.warn("Error caching assessment for serieId:",n,e)}}(t,a),n.dataset.geminiProcessed="true"),e&&e.remove()}),{batchResults:o,novelsData:i}}async function M(){if(!l()&&!await new Promise(n=>{document.getElementById("gemini-api-key-modal-input").value="",document.getElementById("gemini-api-key-modal").style.display="block";const e=document.getElementById("gemini-api-key-modal-save"),t=document.getElementById("gemini-api-key-modal-close");e.addEventListener("click",()=>{const e=document.getElementById("gemini-api-key-modal-input").value.trim();e?(r({...s(),apiKey:e}),document.getElementById("gemini-api-key-modal").style.display="none",n(!0)):alert("Please enter a valid API key.")},{once:!0}),t.addEventListener("click",()=>{document.getElementById("gemini-api-key-modal").style.display="none",n(!1)},{once:!0})}))return;if(0===g.size)return console.error("PROCESSING HALTED: Serie ID map is empty. Cannot proceed with invalid mappings."),m("Processing aborted: Serie ID map validation failed (empty map)"),void h();const n=Array.from(document.querySelectorAll(".series-list > .card")),e=[];for(const t of n){const n=t.querySelector("a[data-novel-id]");let i=null,o=null;if(n){if(o=n.dataset.novelId,!o){console.warn(`No serie_id mapping found for raw_id ${o}. Skipping this novel.`),m(`Skipping novel with raw_id ${o}: No mapping in serieIdMap`);continue}if(i=y(o),i&&!f(o,i))return console.error(`PROCESSING HALTED: Invalid serie_id mapping detected for raw_id ${o}`),m(`Processing aborted: Mapping validation failed for raw_id ${o}`),void h()}i&&!x(i)&&e.push(t)}if(0===e.length)return void alert("No new novels to analyze.");const t=d(),i=e.slice(0,t),o=i.map(n=>function(n){const e=document.createElement("div");e.className="gemini-processing-overlay",e.textContent="Analyzing...";const t=n.querySelector(".card-body");return t&&(t.style.position="relative",t.appendChild(e)),e}(n));try{0===(await $(i,o)).novelsData.length&&m("All novels in batch were cached - no API call needed")}catch(n){console.error("An error occurred during batch processing:",n),o.forEach(n=>{n&&(n.textContent="Batch Failed",setTimeout(()=>n.remove(),4e3))})}}async function C(){a.apiKey=GM_getValue("geminiApiKey",""),a.batchLimit=parseInt(GM_getValue("batchLimit",5..toString()),10),a.geminiModel=GM_getValue("geminiModel",i),a.debugLoggingEnabled=GM_getValue("debugLoggingEnabled",o),await async function(){for(let n=1;n<=3;n++){if(m(`Attempting to build serie_id map (Attempt ${n}/3)`),await u())return m("Serie ID mapping validation: SUCCESS"),!0;console.warn(`Serie ID mapping failed on attempt ${n}/3`),n<3&&(m("Retrying in 2000ms..."),await c(2e3))}return console.error("Serie ID mapping validation: FAILED after all retry attempts"),!1}()||(console.error("INITIALIZATION FAILED: Unable to build serie_id mapping after all retries"),h()),GM_xmlhttpRequest({method:"GET",url:"https://fonts.googleapis.com/icon?family=Material+Icons",headers:{Accept:"text/css,*/*;q=0.1"},onload:function(n){200===n.status&&n.responseText?(console.log("Successfully loaded Material Icons from Google Fonts"),GM_addStyle(n.responseText)):(console.warn("Failed to load Material Icons from Google Fonts, using fallback icons"),b())},onerror:function(){console.warn("Failed to load Material Icons, using fallback icons"),b()}}),GM_addStyle("/* Main stylesheet for WTR-Lab Novel Reviewer */\n\n/* Card modifications */\n.gemini-good-novel .card-body {\n\tbackground-color: #2e462e !important;\n\tborder: 1px solid #578857;\n} /* Dark Green */\n.gemini-mixed-novel .card-body {\n\tbackground-color: #46402e !important;\n\tborder: 1px solid #887a57;\n} /* Dark Yellow/Orange */\n.gemini-bad-novel .card-body {\n\tbackground-color: #462e2e !important;\n\tborder: 1px solid #885757;\n} /* Dark Red */\n.gemini-processing-overlay {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground-color: rgb(0 0 0 / 50%);\n\tcolor: white;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tfont-size: 1.2em;\n\tz-index: 10;\n\tborder-radius: var(--bs-card-inner-border-radius);\n}\n\n/* Color coding for assessment ratings */\n.assessment-rating {\n\tfont-weight: bold;\n\tpadding: 2px 6px;\n\tborder-radius: 3px;\n}\n\n.assessment-rating.good {\n\tcolor: #4caf50;\n\tbackground-color: rgb(76 175 80 / 10%);\n}\n\n.assessment-rating.mixed {\n\tcolor: #ff9800;\n\tbackground-color: rgb(255 152 0 / 10%);\n}\n\n.assessment-rating.bad {\n\tcolor: #f44336;\n\tbackground-color: rgb(244 67 54 / 10%);\n}\n\n.assessment-rating.unknown {\n\tcolor: #9e9e9e;\n\tbackground-color: rgb(158 158 158 / 10%);\n\tborder: 1px solid rgb(158 158 158 / 30%);\n\tfont-style: italic;\n}\n\n/* Summary Icon and Tooltip */\n.gemini-summary-container {\n\t/* This container is now a direct child of the .card element */\n}\n\n.gemini-summary-trigger {\n\tposition: absolute;\n\ttop: 50%;\n\tright: -40px; /* Position outside the card container */\n\ttransform: translateY(-50%);\n\tcursor: pointer;\n\tz-index: 5;\n\tbackground-color: rgb(0 0 0 / 60%);\n\tborder-radius: 50%;\n\twidth: 32px;\n\theight: 32px;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tcolor: white;\n}\n\n.gemini-summary-trigger .material-icons {\n\tfont-size: 20px;\n}\n\n.gemini-summary-card {\n\tdisplay: none;\n\tposition: absolute;\n\ttop: 50%;\n\tright: calc(100% + 15px); /* Positioned to the right of the novel card */\n\ttransform: translateY(-50%);\n\twidth: 400px;\n\tmax-height: 600px;\n\tbackground-color: #212529;\n\tborder: 1px solid #495057;\n\tborder-radius: 8px;\n\tpadding: 15px;\n\tz-index: 100;\n\tcolor: #f8f9fa;\n\tfont-size: 0.9em;\n\tbox-shadow: 0 6px 12px rgb(0 0 0 / 40%);\n\toverflow-y: auto;\n}\n\n.gemini-summary-card h4 {\n\tmargin: 0 0 8px;\n\tcolor: #fff;\n\tfont-size: 1.1em;\n\tfont-weight: 600;\n}\n\n.gemini-summary-card h5 {\n\tmargin: 10px 0 5px;\n\tcolor: #adb5bd;\n\tfont-size: 1em;\n\tfont-weight: 500;\n}\n\n.gemini-summary-card p {\n\tmargin: 0 0 10px;\n\tline-height: 1.4;\n}\n\n.gemini-summary-card .assessment-section {\n\tmargin-bottom: 12px;\n}\n\n.gemini-summary-card .assessment-grid {\n\tdisplay: grid;\n\tgrid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n\tgap: 8px;\n\tmargin-top: 8px;\n}\n\n.gemini-summary-card .assessment-item {\n\tfont-size: 0.85em;\n}\n\n.gemini-summary-card .summary-toggle {\n\tcursor: pointer;\n\tuser-select: none;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tbackground-color: rgb(255 255 255 / 5%);\n\tpadding: 8px 12px;\n\tborder-radius: 4px;\n\tmargin-bottom: 8px;\n\ttransition: background-color 0.2s ease;\n}\n\n.gemini-summary-card .summary-toggle:hover {\n\tbackground-color: rgb(255 255 255 / 10%);\n}\n\n.gemini-summary-card .summary-toggle .toggle-icon {\n\tfont-size: 1.2em;\n\ttransition: transform 0.2s ease;\n}\n\n.gemini-summary-card .summary-toggle.collapsed .toggle-icon {\n\ttransform: rotate(-90deg);\n}\n\n.gemini-summary-card .summary-content {\n\tmax-height: 0;\n\toverflow: hidden;\n\ttransition: max-height 0.3s ease;\n\tmargin-bottom: 10px;\n}\n\n.gemini-summary-card .summary-content.expanded {\n\tmax-height: 200px; /* Scrolling enabled for long content */\n\toverflow-y: auto;\n}\n\n.gemini-summary-card .summary-content p {\n\tmargin: 10px 0;\n\tline-height: 1.4;\n\tpadding: 0 12px;\n}\n\n.gemini-summary-card.locked {\n\tdisplay: block;\n}\n\n.gemini-summary-card:hover:not(.locked),\n.gemini-summary-trigger:hover + .gemini-summary-card:not(.locked) {\n\tdisplay: block;\n}\n\n/* Color-coded Username Styling */\n.username-color-coded {\n\tbackground-color: rgb(255 255 255 / 10%);\n\tpadding: 1px 3px;\n\tborder-radius: 2px;\n\tfont-weight: 600;\n\ttransition: all 0.2s ease;\n\tborder: 1px solid transparent;\n}\n\n.username-color-coded:hover {\n\tbackground-color: rgb(255 255 255 / 20%);\n\tborder-color: rgb(255 255 255 / 30%);\n\ttransform: translateY(-1px);\n}\n\n/* Anonymous user styling */\n.username-color-coded.anonymous {\n\tbackground-color: rgb(149 165 166 / 20%);\n\tcolor: #bdc3c7 !important;\n\tborder: 1px solid rgb(189 195 199 / 30%);\n}\n\n/* Floating Action Button */\n#gemini-floating-analyze-btn {\n\tposition: fixed;\n\ttop: 20px;\n\tright: 20px;\n\twidth: 56px;\n\theight: 56px;\n\tbackground-color: #0d6efd;\n\tcolor: white;\n\tborder: none;\n\tborder-radius: 50%;\n\tcursor: pointer;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tbox-shadow: 0 4px 8px rgb(0 0 0 / 30%);\n\tz-index: 9998;\n\ttransition: background-color 0.3s ease;\n}\n\n#gemini-floating-analyze-btn:hover {\n\tbackground-color: #0b5ed7;\n}\n\n#gemini-floating-analyze-btn .material-icons {\n\tfont-size: 28px;\n}\n\n/* Settings Panel */\n#gemini-settings-panel {\n\tdisplay: none;\n\tposition: fixed;\n\ttop: 50%;\n\tleft: 50%;\n\ttransform: translate(-50%, -50%);\n\tbackground-color: #2c3034;\n\tcolor: white;\n\tpadding: 20px;\n\tborder-radius: 8px;\n\tbox-shadow: 0 5px 15px rgb(0 0 0 / 50%);\n\tz-index: 9999;\n\twidth: 400px;\n}\n\n#gemini-settings-panel h3 {\n\tmargin-top: 0;\n}\n\n#gemini-settings-panel label {\n\tdisplay: block;\n\tmargin: 10px 0 5px;\n}\n\n#gemini-settings-panel input,\n#gemini-settings-panel select {\n\twidth: 100%;\n\tpadding: 8px;\n\tborder-radius: 4px;\n\tborder: 1px solid #495057;\n\tbackground-color: #212529;\n\tcolor: white;\n\tbox-sizing: border-box;\n}\n\n#gemini-settings-panel .buttons {\n\tmargin-top: 20px;\n\ttext-align: right;\n}\n\n#gemini-settings-panel button {\n\tmargin-left: 10px;\n\tpadding: 8px 15px;\n\tborder-radius: 4px;\n\tborder: none;\n\tcursor: pointer;\n}\n\n#gemini-settings-save {\n\tbackground-color: #0d6efd;\n\tcolor: white;\n}\n\n#gemini-settings-close {\n\tbackground-color: #6c757d;\n\tcolor: white;\n}\n\n/* API Key Modal */\n#gemini-api-key-modal {\n\tdisplay: none;\n\tposition: fixed;\n\ttop: 50%;\n\tleft: 50%;\n\ttransform: translate(-50%, -50%);\n\tbackground-color: #2c3034;\n\tcolor: white;\n\tpadding: 20px;\n\tborder-radius: 8px;\n\tbox-shadow: 0 5px 15px rgb(0 0 0 / 50%);\n\tz-index: 9999;\n\twidth: 500px;\n\tmax-height: 80vh;\n\toverflow-y: auto;\n}\n\n#gemini-api-key-modal h3 {\n\tmargin-top: 0;\n\tcolor: #fff;\n\ttext-align: center;\n}\n\n#gemini-api-key-modal .instructions {\n\tmargin-bottom: 20px;\n}\n\n#gemini-api-key-modal .instructions ol {\n\ttext-align: left;\n\tpadding-left: 20px;\n}\n\n#gemini-api-key-modal .instructions li {\n\tmargin-bottom: 8px;\n}\n\n#gemini-api-key-modal label {\n\tdisplay: block;\n\tmargin: 10px 0 5px;\n\tfont-weight: bold;\n}\n\n#gemini-api-key-modal input {\n\twidth: 100%;\n\tpadding: 8px;\n\tborder-radius: 4px;\n\tborder: 1px solid #495057;\n\tbackground-color: #212529;\n\tcolor: white;\n\tbox-sizing: border-box;\n}\n\n#gemini-api-key-modal .buttons {\n\tmargin-top: 20px;\n\ttext-align: center;\n}\n\n#gemini-api-key-modal button {\n\tmargin: 0 10px;\n\tpadding: 8px 15px;\n\tborder-radius: 4px;\n\tborder: none;\n\tcursor: pointer;\n\tbackground-color: #0d6efd;\n\tcolor: white;\n}\n\n#gemini-api-key-modal-close {\n\tbackground-color: #6c757d;\n}\n\n/* Mapping Failure Notification */\n#gemini-mapping-failure-notification {\n\tposition: fixed;\n\ttop: 80px;\n\tright: 20px;\n\twidth: 400px;\n\tbackground-color: #dc3545;\n\tcolor: white;\n\tborder-radius: 8px;\n\tbox-shadow: 0 6px 16px rgb(0 0 0 / 40%);\n\tz-index: 10000;\n\tanimation: slide-in-right 0.3s ease-out;\n}\n\n#gemini-mapping-failure-notification .notification-content {\n\tdisplay: flex;\n\talign-items: flex-start;\n\tpadding: 16px;\n\tgap: 12px;\n}\n\n#gemini-mapping-failure-notification .notification-icon {\n\tfont-size: 28px;\n\tflex-shrink: 0;\n}\n\n#gemini-mapping-failure-notification .notification-text {\n\tflex: 1;\n}\n\n#gemini-mapping-failure-notification .notification-text strong {\n\tdisplay: block;\n\tfont-size: 1.1em;\n\tmargin-bottom: 4px;\n}\n\n#gemini-mapping-failure-notification .notification-text p {\n\tmargin: 0;\n\tfont-size: 0.95em;\n\tline-height: 1.4;\n}\n\n#gemini-mapping-failure-notification .notification-close {\n\tbackground: none;\n\tborder: none;\n\tcolor: white;\n\tfont-size: 24px;\n\tcursor: pointer;\n\tpadding: 0;\n\twidth: 24px;\n\theight: 24px;\n\tline-height: 1;\n\tflex-shrink: 0;\n}\n\n#gemini-mapping-failure-notification .notification-close:hover {\n\topacity: 0.8;\n}\n\n@keyframes slide-in-right {\n\tfrom {\n\t\ttransform: translateX(100%);\n\t\topacity: 0;\n\t}\n\n\tto {\n\t\ttransform: translateX(0);\n\t\topacity: 1;\n\t}\n}\n\n/* Mobile considerations */\n@media (width <= 768px) {\n\t.gemini-summary-card {\n\t\twidth: 300px;\n\t\tmax-height: 400px;\n\t}\n\n\t#gemini-api-key-modal {\n\t\twidth: 90%;\n\t\tpadding: 15px;\n\t}\n\n\t#gemini-mapping-failure-notification {\n\t\twidth: calc(100% - 40px);\n\t\tright: 20px;\n\t\tleft: 20px;\n\t}\n}\n\n/* Material Icons font declaration */\n.material-icons {\n\tfont-family: 'Material Icons';\n\tfont-weight: normal;\n\tfont-style: normal;\n\tfont-size: 24px;\n\tline-height: 1;\n\tletter-spacing: normal;\n\ttext-transform: none;\n\tdisplay: inline-block;\n\twhite-space: nowrap;\n\tword-wrap: normal;\n\tdirection: ltr;\n\t-webkit-font-feature-settings: 'liga';\n\t-webkit-font-smoothing: antialiased;\n}"),function(){const e=`\n\t\t<div id="gemini-settings-panel">\n\t\t\t<h3>Gemini Reviewer Settings</h3>\n\t\t\t<label for="gemini-api-key-input">Gemini API Key:</label>\n\t\t\t<input type="password" id="gemini-api-key-input">\n\t\t\t<label for="gemini-batch-limit-input">Batch Limit:</label>\n\t\t\t<input type="number" id="gemini-batch-limit-input" min="1">\n\t\t\t<label for="gemini-model-select">Gemini Model:</label>\n\t\t\t<select id="gemini-model-select">${n.map(n=>`<option value="${n}">${n}</option>`).join("")}</select>\n\t\t\t<label for="gemini-debug-logging-input" style="display: flex; align-items: center;">\n\t\t\t\t<input type="checkbox" id="gemini-debug-logging-input" style="width: auto; margin-right: 10px;">\n\t\t\t\tEnable Debug Logging (Logs prompts and responses)\n\t\t\t</label>\n\t\t\t<div class="buttons">\n\t\t\t\t<button id="gemini-settings-close">Close</button>\n\t\t\t\t<button id="gemini-settings-save">Save</button>\n\t\t\t</div>\n\t\t</div>\n\t`;document.body.insertAdjacentHTML("beforeend",e)}(),document.body.insertAdjacentHTML("beforeend",'\n\t\t<div id="gemini-api-key-modal">\n\t\t\t<h3>How to Get Your FREE Gemini API Token</h3>\n\t\t\t<div class="instructions">\n\t\t\t\t<ol>\n\t\t\t\t\t<li>Go to <a href="https://aistudio.google.com/" target="_blank" style="color: #0d6efd;">Google AI Studio</a></li>\n\t\t\t\t\t<li>Sign in with your Google account</li>\n\t\t\t\t\t<li>Click "Get API key in Google AI Studio"</li>\n\t\t\t\t\t<li>Create a new API key or use an existing one</li>\n\t\t\t\t\t<li>Copy the API key and paste it below</li>\n\t\t\t\t</ol>\n\t\t\t</div>\n\t\t\t<label for="gemini-api-key-modal-input">Gemini API Key:</label>\n\t\t\t<input type="password" id="gemini-api-key-modal-input" placeholder="Enter your Gemini API key here">\n\t\t\t<div class="buttons">\n\t\t\t\t<button id="gemini-api-key-modal-close">Cancel</button>\n\t\t\t\t<button id="gemini-api-key-modal-save">Save & Continue</button>\n\t\t\t</div>\n\t\t</div>\n\t'),GM_registerMenuCommand("Open Settings",()=>{const n=s();document.getElementById("gemini-api-key-input").value=n.apiKey,document.getElementById("gemini-batch-limit-input").value=n.batchLimit,document.getElementById("gemini-model-select").value=n.geminiModel,document.getElementById("gemini-debug-logging-input").checked=n.debugLoggingEnabled,document.getElementById("gemini-settings-panel").style.display="block"}),document.getElementById("gemini-settings-save").addEventListener("click",()=>{r({apiKey:document.getElementById("gemini-api-key-input").value,batchLimit:parseInt(document.getElementById("gemini-batch-limit-input").value,10),geminiModel:document.getElementById("gemini-model-select").value,debugLoggingEnabled:document.getElementById("gemini-debug-logging-input").checked}),alert("Settings saved."),document.getElementById("gemini-settings-panel").style.display="none"}),document.getElementById("gemini-settings-close").addEventListener("click",()=>{document.getElementById("gemini-settings-panel").style.display="none"}),new MutationObserver(()=>{document.querySelector(".series-list")&&(function(){if(document.getElementById("gemini-floating-analyze-btn"))return;const n=document.createElement("button");n.id="gemini-floating-analyze-btn";const e=d();n.title=`Analyze Next Batch of Novels (${e})`;const t=window.__ICON_REPLACEMENTS__?"material-icons-fallback":"material-icons",i=window.__ICON_REPLACEMENTS__?"üìä":"assessment";n.innerHTML=`<span class="${t}">${i}</span>`,n.addEventListener("click",M),document.body.appendChild(n)}(),Array.from(document.querySelectorAll(".series-list > .card:not([data-gemini-processed]):not([data-gemini-cached-checked])")).forEach(n=>{const e=n.querySelector("a[data-novel-id]");let t=null,i=null;if(e)if(i=e.dataset.novelId,i)t=y(i);else{if(e.href){const n=e.href.match(/\/novel\/(\d+)\//);n&&n[1]&&(t=n[1])}!t&&i&&(t=i)}if(t){let e=x(t);e&&(e.availableUsernames||(e.availableUsernames=[]),e=I(e),_(n,e))}n.dataset.geminiCachedChecked="true"}))}).observe(document.body,{childList:!0,subtree:!0})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",C):C()})();