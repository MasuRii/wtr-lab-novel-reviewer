// ==UserScript==
// @name WTR-Lab Novel Reviewer
// @description Analyzes novels on wtr-lab.com using Gemini AI to provide comprehensive assessments including character development, plot structure, world-building, themes & messages, and writing style.
// @version 1.8.7
// @author MasuRii
// @supportURL https://github.com/MasuRii/wtr-lab-novel-reviewer/issues
// @match https://wtr-lab.com/en/for-you
// @match https://wtr-lab.com/en/for-you?*
// @match https://wtr-lab.com/en/novel-finder*
// @connect generativelanguage.googleapis.com
// @connect fonts.googleapis.com
// @downloadURL https://raw.githubusercontent.com/MasuRii/wtr-lab-novel-reviewer/main/dist/wtr-lab-novel-reviewer.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @grant GM_xmlhttpRequest
// @grant GM_getResourceText
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://raw.githubusercontent.com/MasuRii/wtr-lab-novel-reviewer/main/dist/wtr-lab-novel-reviewer.user.js
// @website https://github.com/MasuRii/wtr-lab-novel-reviewer
// ==/UserScript==

(()=>{"use strict";var t={41:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Mobile considerations */\n.mobile-close-btn {\n\tdisplay: none; /* Hidden by default on desktop */\n}\n\n@media (width <= 768px) {\n\t.mobile-close-btn {\n\t\tdisplay: block;\n\t\tposition: absolute;\n\t\ttop: 10px;\n\t\tright: 10px;\n\t\twidth: 30px;\n\t\theight: 30px;\n\t\tbackground: rgb(255 255 255 / 10%);\n\t\tborder-radius: 50%;\n\t\ttext-align: center;\n\t\tline-height: 30px;\n\t\tfont-size: 20px;\n\t\tcursor: pointer;\n\t\tz-index: 101; /* Above content */\n\t}\n\n\t.gemini-summary-card {\n\t\tposition: fixed;\n\t\ttop: 50%;\n\t\tleft: 50%;\n\t\ttransform: translate(-50%, -50%);\n\t\twidth: 90%;\n\t\tmax-width: 400px;\n\t\tmax-height: 80vh;\n\t\tz-index: 1000;\n\t}\n\n\t#gemini-api-key-modal {\n\t\twidth: 95%;\n\t\tpadding: 15px;\n\t}\n\n\t#gemini-api-key-modal .buttons {\n\t\tflex-direction: column;\n\t\tgap: 10px;\n\t}\n\n\t#gemini-api-key-modal button {\n\t\twidth: 100%;\n\t\tmargin: 0;\n\t}\n\n\t/* Settings Panel responsive design */\n\t#gemini-settings-panel {\n\t\twidth: 95%;\n\t\tmax-width: none;\n\t\tpadding: 15px;\n\t}\n\n\t#gemini-settings-panel .buttons {\n\t\tflex-direction: column;\n\t\talign-items: stretch;\n\t\tgap: 10px;\n\t}\n\n\t#gemini-settings-panel .clear-cache-btn {\n\t\tmargin-right: 0;\n\t\torder: 2;\n\t\twidth: 100%;\n\t}\n\n\t#gemini-settings-panel .buttons button:not(.clear-cache-btn) {\n\t\twidth: 100%;\n\t\tmargin-left: 0;\n\t}\n\n\t#gemini-mapping-failure-notification {\n\t\twidth: calc(100% - 40px);\n\t\tright: 20px;\n\t\tleft: 20px;\n\t}\n}\n\n/* Extra small screens */\n@media (width <= 600px) {\n\t#gemini-settings-panel {\n\t\twidth: 98%;\n\t\tpadding: 12px;\n\t}\n\n\t#gemini-settings-panel .buttons {\n\t\tgap: 8px;\n\t}\n\n\t#gemini-settings-panel button {\n\t\tpadding: 10px 12px;\n\t\tfont-size: 14px;\n\t}\n\n\t#gemini-api-key-modal {\n\t\twidth: 98%;\n\t\tpadding: 12px;\n\t}\n\n\t#gemini-api-key-modal .buttons {\n\t\tgap: 8px;\n\t}\n\n\t#gemini-api-key-modal button {\n\t\tpadding: 10px 12px;\n\t\tfont-size: 14px;\n\t}\n}\n",""]);const s=r},56:(t,n,e)=>{t.exports=function(t){var n=e.nc;n&&t.setAttribute("nonce",n)}},72:t=>{var n=[];function e(t){for(var e=-1,i=0;i<n.length;i++)if(n[i].identifier===t){e=i;break}return e}function i(t,i){for(var a={},r=[],s=0;s<t.length;s++){var l=t[s],c=i.base?l[0]+i.base:l[0],d=a[c]||0,m="".concat(c," ").concat(d);a[c]=d+1;var g=e(m),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==g)n[g].references++,n[g].updater(u);else{var p=o(u,i);i.byIndex=s,n.splice(s,0,{identifier:m,updater:p,references:1})}r.push(m)}return r}function o(t,n){var e=n.domAPI(n);return e.update(t),function(n){if(n){if(n.css===t.css&&n.media===t.media&&n.sourceMap===t.sourceMap&&n.supports===t.supports&&n.layer===t.layer)return;e.update(t=n)}else e.remove()}}t.exports=function(t,o){var a=i(t=t||[],o=o||{});return function(t){t=t||[];for(var r=0;r<a.length;r++){var s=e(a[r]);n[s].references--}for(var l=i(t,o),c=0;c<a.length;c++){var d=e(a[c]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}a=l}}},113:t=>{t.exports=function(t,n){if(n.styleSheet)n.styleSheet.cssText=t;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(t))}}},193:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Color coding for assessment ratings */\n.assessment-rating {\n\tfont-weight: bold;\n\tpadding: 2px 6px;\n\tborder-radius: 3px;\n}\n\n.assessment-rating.good {\n\tcolor: #4caf50;\n\tbackground-color: rgb(76 175 80 / 10%);\n}\n\n.assessment-rating.mixed {\n\tcolor: #ff9800;\n\tbackground-color: rgb(255 152 0 / 10%);\n}\n\n.assessment-rating.bad {\n\tcolor: #f44336;\n\tbackground-color: rgb(244 67 54 / 10%);\n}\n\n.assessment-rating.unknown {\n\tcolor: #9e9e9e;\n\tbackground-color: rgb(158 158 158 / 10%);\n\tborder: 1px solid rgb(158 158 158 / 30%);\n\tfont-style: italic;\n}\n",""]);const s=r},229:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Base stylesheet for WTR-Lab Novel Reviewer */\n\n/* Keyframe animations */\n@keyframes slide-in-right {\n\tfrom {\n\t\ttransform: translateX(100%);\n\t\topacity: 0;\n\t}\n\n\tto {\n\t\ttransform: translateX(0);\n\t\topacity: 1;\n\t}\n}\n\n/* Utility classes */\n.material-icons {\n\t/* Inherit from vendor/_material-icons.css */\n}\n",""]);const s=r},279:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Mapping Failure Notification */\n#gemini-mapping-failure-notification {\n\tposition: fixed;\n\ttop: 80px;\n\tright: 20px;\n\twidth: 400px;\n\tbackground-color: #dc3545;\n\tcolor: white;\n\tborder-radius: 8px;\n\tbox-shadow: 0 6px 16px rgb(0 0 0 / 40%);\n\tz-index: 10000;\n\tanimation: slide-in-right 0.3s ease-out;\n}\n\n#gemini-mapping-failure-notification .notification-content {\n\tdisplay: flex;\n\talign-items: flex-start;\n\tpadding: 16px;\n\tgap: 12px;\n}\n\n#gemini-mapping-failure-notification .notification-icon {\n\tfont-size: 28px;\n\tflex-shrink: 0;\n}\n\n#gemini-mapping-failure-notification .notification-text {\n\tflex: 1;\n}\n\n#gemini-mapping-failure-notification .notification-text strong {\n\tdisplay: block;\n\tfont-size: 1.1em;\n\tmargin-bottom: 4px;\n}\n\n#gemini-mapping-failure-notification .notification-text p {\n\tmargin: 0;\n\tfont-size: 0.95em;\n\tline-height: 1.4;\n}\n\n#gemini-mapping-failure-notification .notification-close {\n\tbackground: none;\n\tborder: none;\n\tcolor: white;\n\tfont-size: 24px;\n\tcursor: pointer;\n\tpadding: 0;\n\twidth: 24px;\n\theight: 24px;\n\tline-height: 1;\n\tflex-shrink: 0;\n}\n\n#gemini-mapping-failure-notification .notification-close:hover {\n\topacity: 0.8;\n}\n",""]);const s=r},314:t=>{t.exports=function(t){var n=[];return n.toString=function(){return this.map(function(n){var e="",i=void 0!==n[5];return n[4]&&(e+="@supports (".concat(n[4],") {")),n[2]&&(e+="@media ".concat(n[2]," {")),i&&(e+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),e+=t(n),i&&(e+="}"),n[2]&&(e+="}"),n[4]&&(e+="}"),e}).join("")},n.i=function(t,e,i,o,a){"string"==typeof t&&(t=[[null,t,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<t.length;c++){var d=[].concat(t[c]);i&&r[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),e&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=e):d[2]=e),o&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=o):d[4]="".concat(o)),n.push(d))}},n}},355:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Title area styling to accommodate the summary trigger */\n.title-wrap {\n\tposition: relative;\n\tpadding-right: 45px; /* Space for the summary trigger button */\n}\n\n/* Summary Icon and Tooltip */\n.gemini-summary-container {\n\t/* This container is now a direct child of the .card element */\n}\n\n.gemini-summary-trigger {\n\tposition: absolute;\n\ttop: 50%;\n\tright: 8px; /* Position within the title-wrap padding area */\n\ttransform: translateY(-50%);\n\tcursor: pointer;\n\tz-index: 5;\n\tbackground-color: rgb(0 0 0 / 60%);\n\tborder-radius: 50%;\n\twidth: 28px;\n\theight: 28px;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tcolor: white;\n}\n\n.gemini-summary-trigger .material-icons {\n\tfont-size: 16px;\n}\n\n.gemini-summary-card {\n\tdisplay: none;\n\tposition: absolute;\n\ttop: 50%;\n\tright: calc(100% + 15px);\n\ttransform: translateY(-50%);\n\twidth: 400px;\n\tmax-height: 600px;\n\tbackground-color: #212529;\n\tborder: 1px solid #495057;\n\tborder-radius: 8px;\n\tpadding: 15px;\n\tz-index: 100;\n\tcolor: #f8f9fa;\n\tfont-size: 0.9em;\n\tbox-shadow: 0 6px 12px rgb(0 0 0 / 40%);\n\toverflow-y: auto;\n}\n\n.gemini-summary-card h4 {\n\tmargin: 0 0 8px;\n\tcolor: #fff;\n\tfont-size: 1.1em;\n\tfont-weight: 600;\n}\n\n.gemini-summary-card h5 {\n\tmargin: 10px 0 5px;\n\tcolor: #adb5bd;\n\tfont-size: 1em;\n\tfont-weight: 500;\n}\n\n.gemini-summary-card p {\n\tmargin: 0 0 10px;\n\tline-height: 1.4;\n}\n\n.gemini-summary-card .assessment-section {\n\tmargin-bottom: 12px;\n}\n\n.gemini-summary-card .assessment-grid {\n\tdisplay: grid;\n\tgrid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n\tgap: 8px;\n\tmargin-top: 8px;\n}\n\n.gemini-summary-card .assessment-item {\n\tfont-size: 0.85em;\n}\n\n.gemini-summary-card .summary-toggle {\n\tcursor: pointer;\n\tuser-select: none;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tbackground-color: rgb(255 255 255 / 5%);\n\tpadding: 8px 12px;\n\tborder-radius: 4px;\n\tmargin-bottom: 8px;\n\ttransition: background-color 0.2s ease;\n}\n\n.gemini-summary-card .summary-toggle:hover {\n\tbackground-color: rgb(255 255 255 / 10%);\n}\n\n.gemini-summary-card .summary-toggle .toggle-icon {\n\tfont-size: 1.2em;\n\ttransition: transform 0.2s ease;\n}\n\n.gemini-summary-card .summary-toggle.collapsed .toggle-icon {\n\ttransform: rotate(-90deg);\n}\n\n.gemini-summary-card .summary-content {\n\tmax-height: 0;\n\toverflow: hidden;\n\ttransition: max-height 0.3s ease;\n\tmargin-bottom: 10px;\n}\n\n.gemini-summary-card .summary-content.expanded {\n\tmax-height: 200px; /* Scrolling enabled for long content */\n\toverflow-y: auto;\n}\n\n.gemini-summary-card .summary-content p {\n\tmargin: 10px 0;\n\tline-height: 1.4;\n\tpadding: 0 12px;\n}\n\n.gemini-summary-card.locked {\n\tdisplay: block;\n}\n\n.gemini-summary-card:hover:not(.locked),\n.gemini-summary-trigger:hover + .gemini-summary-card:not(.locked) {\n\tdisplay: block;\n}\n",""]);const s=r},483:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,'/* Material Icons font declarations */\n@font-face {\n\tfont-family: "Material Icons";\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: url("https://fonts.gstatic.com/s/materialicons/v145/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2") format("woff2");\n}\n\n@font-face {\n\tfont-family: "Material Icons Outlined";\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: url("https://fonts.gstatic.com/s/materialiconsoutlined/v110/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUcd.otf")\n\t\tformat("opentype");\n}\n\n@font-face {\n\tfont-family: "Material Icons Round";\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: url("https://fonts.gstatic.com/s/materialiconsround/v109/LDItaoyNOAY6Uewc665JcIzCKsKc_M9flwmM.otf")\n\t\tformat("opentype");\n}\n\n@font-face {\n\tfont-family: "Material Icons Sharp";\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: url("https://fonts.gstatic.com/s/materialiconssharp/v110/oPWQ_lt5nv4pWNJpghLP75WiFR4kLh3kvmvS.otf")\n\t\tformat("opentype");\n}\n\n@font-face {\n\tfont-family: "Material Icons Two Tone";\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: url("https://fonts.gstatic.com/s/materialiconstwotone/v113/hESh6WRmNCxEqUmNyh3JDeGxjVVyMg4tHGctNCu3.otf")\n\t\tformat("opentype");\n}\n\n/* Material Icons font declaration */\n.material-icons {\n\tfont-family: "Material Icons", sans-serif;\n\tfont-weight: normal;\n\tfont-style: normal;\n\tfont-size: 24px;\n\tline-height: 1;\n\tletter-spacing: normal;\n\ttext-transform: none;\n\tdisplay: inline-block;\n\twhite-space: nowrap;\n\toverflow-wrap: normal;\n\tdirection: ltr;\n\tfont-feature-settings: "liga";\n\t-webkit-font-smoothing: antialiased;\n}\n',""]);const s=r},532:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Button Components */\n\n.gemini-summary-trigger.disabled {\n\tbackground-color: rgb(128 128 128 / 60%); /* Greyed out */\n\tcursor: not-allowed;\n\topacity: 0.7;\n}\n",""]);const s=r},538:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,'/* Settings Panel */\n#gemini-settings-panel {\n\tdisplay: none;\n\tposition: fixed;\n\ttop: 50%;\n\tleft: 50%;\n\ttransform: translate(-50%, -50%);\n\tbackground-color: #2c3034;\n\tcolor: white;\n\tpadding: 20px;\n\tborder-radius: 8px;\n\tbox-shadow: 0 5px 15px rgb(0 0 0 / 50%);\n\tz-index: 9999;\n\tmax-width: 500px;\n\twidth: 100%;\n}\n\n#gemini-settings-panel h3 {\n\tmargin-top: 0;\n}\n\n#gemini-settings-panel label {\n\tdisplay: block;\n\tmargin: 10px 0 5px;\n}\n\n#gemini-settings-panel input,\n#gemini-settings-panel select {\n\twidth: 100%;\n\tpadding: 8px;\n\tborder-radius: 4px;\n\tborder: 1px solid #495057;\n\tbackground-color: #212529;\n\tcolor: white;\n\tbox-sizing: border-box;\n}\n\n/* Debug logging label with flexbox for checkbox alignment */\n#gemini-settings-panel .debug-logging-label {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 10px;\n}\n\n#gemini-settings-panel .debug-logging-label input[type="checkbox"] {\n\twidth: auto;\n\tmargin: 0;\n}\n\n#gemini-settings-panel .buttons {\n\tmargin-top: 20px;\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tgap: 10px;\n}\n\n/* Clear cache button pushed to the left */\n#gemini-settings-panel .clear-cache-btn {\n\tbackground-color: #dc3545;\n\tcolor: white;\n\tmargin-right: auto;\n}\n\n/* General button styling */\n#gemini-settings-panel button {\n\tpadding: 8px 15px;\n\tborder-radius: 4px;\n\tborder: none;\n\tcursor: pointer;\n}\n\n#gemini-settings-save {\n\tbackground-color: #0d6efd;\n\tcolor: white;\n}\n\n#gemini-settings-close {\n\tbackground-color: #6c757d;\n\tcolor: white;\n}\n\n/* API Key Modal */\n#gemini-api-key-modal {\n\tdisplay: none;\n\tposition: fixed;\n\ttop: 50%;\n\tleft: 50%;\n\ttransform: translate(-50%, -50%);\n\tbackground-color: #2c3034;\n\tcolor: white;\n\tpadding: 20px;\n\tborder-radius: 8px;\n\tbox-shadow: 0 5px 15px rgb(0 0 0 / 50%);\n\tz-index: 9999;\n\twidth: 100%;\n\tmax-width: 500px;\n\tmax-height: 80vh;\n\toverflow-y: auto;\n}\n\n#gemini-api-key-modal h3 {\n\tmargin-top: 0;\n\tcolor: #fff;\n\ttext-align: center;\n}\n\n#gemini-api-key-modal .instructions {\n\tmargin-bottom: 20px;\n}\n\n#gemini-api-key-modal .instructions ol {\n\ttext-align: left;\n\tpadding-left: 20px;\n}\n\n#gemini-api-key-modal .instructions li {\n\tmargin-bottom: 8px;\n}\n\n#gemini-api-key-modal label {\n\tdisplay: block;\n\tmargin: 10px 0 5px;\n\tfont-weight: bold;\n}\n\n#gemini-api-key-modal input {\n\twidth: 100%;\n\tpadding: 8px;\n\tborder-radius: 4px;\n\tborder: 1px solid #495057;\n\tbackground-color: #212529;\n\tcolor: white;\n\tbox-sizing: border-box;\n}\n\n#gemini-api-key-modal .buttons {\n\tmargin-top: 20px;\n\tdisplay: flex;\n\tjustify-content: flex-end;\n}\n\n#gemini-api-key-modal button {\n\tmargin: 0 0 0 10px;\n\tpadding: 8px 15px;\n\tborder-radius: 4px;\n\tborder: none;\n\tcursor: pointer;\n\tbackground-color: #0d6efd;\n\tcolor: white;\n}\n\n#gemini-api-key-modal-close {\n\tbackground-color: #6c757d;\n}\n',""]);const s=r},540:t=>{t.exports=function(t){var n=document.createElement("style");return t.setAttributes(n,t.attributes),t.insert(n,t.options),n}},601:t=>{t.exports=function(t){return t[1]}},659:t=>{var n={};t.exports=function(t,e){var i=function(t){if(void 0===n[t]){var e=document.querySelector(t);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(t){e=null}n[t]=e}return n[t]}(t);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(e)}},731:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Color-coded Username Styling */\n.username-color-coded {\n\tbackground-color: rgb(255 255 255 / 10%);\n\tpadding: 1px 3px;\n\tborder-radius: 2px;\n\tfont-weight: 600;\n\ttransition: all 0.2s ease;\n\tborder: 1px solid transparent;\n}\n\n.username-color-coded:hover {\n\tbackground-color: rgb(255 255 255 / 20%);\n\tborder-color: rgb(255 255 255 / 30%);\n\ttransform: translateY(-1px);\n}\n\n/* Anonymous user styling */\n.username-color-coded.anonymous {\n\tbackground-color: rgb(149 165 166 / 20%);\n\tcolor: #bdc3c7 !important;\n\tborder: 1px solid rgb(189 195 199 / 30%);\n}\n",""]);const s=r},825:t=>{t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=t.insertStyleElement(t);return{update:function(e){!function(t,n,e){var i="";e.supports&&(i+="@supports (".concat(e.supports,") {")),e.media&&(i+="@media ".concat(e.media," {"));var o=void 0!==e.layer;o&&(i+="@layer".concat(e.layer.length>0?" ".concat(e.layer):""," {")),i+=e.css,o&&(i+="}"),e.media&&(i+="}"),e.supports&&(i+="}");var a=e.sourceMap;a&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),n.styleTagTransform(i,t,n.options)}(n,t,e)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(n)}}}},933:(t,n,e)=>{e.d(n,{A:()=>s});var i=e(601),o=e.n(i),a=e(314),r=e.n(a)()(o());r.push([t.id,"/* Card modifications */\n.gemini-good-novel .card-body {\n\tbackground-color: #2e462e !important;\n\tborder: 1px solid #578857;\n} /* Dark Green */\n\n.gemini-mixed-novel .card-body {\n\tbackground-color: #46402e !important;\n\tborder: 1px solid #887a57;\n} /* Dark Yellow/Orange */\n\n.gemini-bad-novel .card-body {\n\tbackground-color: #462e2e !important;\n\tborder: 1px solid #885757;\n} /* Dark Red */\n\n.gemini-processing-overlay {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground-color: rgb(0 0 0 / 50%);\n\tcolor: white;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tfont-size: 1.2em;\n\tz-index: 10;\n\tborder-radius: var(--bs-card-inner-border-radius);\n}\n",""]);const s=r}},n={};function e(i){var o=n[i];if(void 0!==o)return o.exports;var a=n[i]={id:i,exports:{}};return t[i](a,a.exports,e),a.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),e.nc=void 0;const i=["gemini-2.5-pro","gemini-flash-latest","gemini-flash-lite-latest","gemini-2.5-flash","gemini-2.5-flash-lite"],o=1e3,a=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#ff5722","#795548","#607d8b","#8bc34a","#ffc107","#673ab7","#00bcd4","#ff9800","#4caf50","#2196f3","#f44336","#9c27b0"],r="gemini-2.5-flash",s=!1;let l={apiKey:"",geminiModel:r,debugLoggingEnabled:s};function c(t){GM_setValue("geminiApiKey",t.apiKey),GM_setValue("geminiModel",t.geminiModel),GM_setValue("debugLoggingEnabled",t.debugLoggingEnabled),l={...t}}function d(){return{...l}}function m(){return l.apiKey}function g(t){return new Promise(n=>setTimeout(n,t))}function u(t,n){l.debugLoggingEnabled&&console.log(`[WTR-Lab Novel Reviewer Debug] ${t}`,n||"")}const p=new Map;let f=!1;async function h(){u("Building serie_id mapping from __NEXT_DATA__");const t=document.querySelector('script[id="__NEXT_DATA__"]');if(!t)return console.warn("__NEXT_DATA__ script not found. Unable to build serie_id mapping."),!1;try{const n=JSON.parse(t.textContent),e=n.props?.pageProps;return y(e),u(`Built serie_id map with ${p.size} entries`),0!==p.size||(console.error("Serie ID mapping failed: Map is empty after building"),!1)}catch(t){return console.error("Error parsing __NEXT_DATA__:",t),!1}}function y(t){t&&(t.series&&Array.isArray(t.series)&&t.series.forEach(t=>{t.raw_id&&t.id&&p.set(t.raw_id.toString(),t.id.toString())}),t.list&&Array.isArray(t.list)&&t.list.forEach(t=>{t.raw_id&&t.serie_id&&p.set(t.raw_id.toString(),t.serie_id.toString())}))}function b(t){return p.get(t)||null}function v(){f=!1}function w(){if(f)return;f=!0;const t=window.__ICON_REPLACEMENTS__?"material-icons-fallback":"material-icons",n=window.__ICON_REPLACEMENTS__?"⚠️":"warning",e=document.createElement("div");e.id="gemini-mapping-failure-notification",e.innerHTML=`\n\t\t<div class="notification-content">\n\t\t\t<span class="${t} notification-icon">${n}</span>\n\t\t\t<div class="notification-text">\n\t\t\t\t<strong>Serie ID Mapping Failed</strong>\n\t\t\t\t<p>Unable to map novel IDs correctly. Please refresh the page to retry.</p>\n\t\t\t</div>\n\t\t\t<button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>\n\t\t</div>\n\t`,document.body.appendChild(e),console.error("MAPPING FAILURE: User has been notified to refresh the page"),u("Mapping failure notification displayed to user")}function x(){try{const t="__localStorage_test__";return localStorage.setItem(t,"test"),localStorage.removeItem(t),!0}catch(t){return!1}}function A(t){return`geminiAssessment_${t}`}function k(t){if(!x())return null;try{const n=A(t),e=localStorage.getItem(n);if(e){const t=JSON.parse(e);if(t&&"object"==typeof t&&t.assessment)return t}}catch(n){console.warn("Error retrieving cached assessment for serieId:",t,n)}return null}let S=!1;const E=new Map;function I(t){const n=new Set;return t.forEach(t=>{if(t.username){const e=t.username.trim();e&&"null"!==e&&"undefined"!==e&&n.add(e)}}),Array.from(n)}function _(t){if(!t)return"";const n=t.toLowerCase();return n.includes("good")||n.includes("excellent")||n.includes("outstanding")||n.includes("very good")||n.includes("strong")?"good":n.includes("mixed")||n.includes("average")||n.includes("decent")||n.includes("fair")||n.includes("moderate")?"mixed":n.includes("bad")||n.includes("poor")||n.includes("weak")||n.includes("lacking")||n.includes("needs improvement")?"bad":n.includes("unknown")||n.includes("missing")||n.includes("unspecified")||n.includes("undetermined")||n.includes("insufficient")?"unknown":""}function $(t,n){const e=n&&n.assessment&&n.summary;if(e){const e=(n=function(t){return t.unknown||(t.unknown="Mixed"),t}(n)).assessment.toLowerCase();"good"===e?t.classList.add("gemini-good-novel"):"mixed"===e?t.classList.add("gemini-mixed-novel"):"bad"===e&&t.classList.add("gemini-bad-novel")}const i=window.__ICON_REPLACEMENTS__?{iconClass:"material-icons-fallback",expandIcon:"▼",autoAwesomeIcon:"⭐"}:{iconClass:"material-icons",expandIcon:"expand_more",autoAwesomeIcon:"auto_awesome"},r=document.createElement("div");r.className="gemini-summary-container";let s=null;if(e){const t=_(n.assessment),e=_(n.characterDevelopment),o=_(n.plotStructure),l=_(n.worldBuilding),c=_(n.themesAndMessages),d=_(n.writingStyle),m=_(n.unknown),g=n.availableUsernames||[];let u="<h4>AI Novel Assessment</h4>";u+='<div class="mobile-close-btn">×</div>',u+='<div class="summary-toggle collapsed" data-target="novel-summary">',u+="<span>Novel Summary</span>",u+=`<span class="${i.iconClass} toggle-icon">${i.expandIcon}</span>`,u+="</div>",u+='<div class="summary-content" id="novel-summary">',u+=`<p>${n.novelSummary}</p>`,u+="</div>";const p=function(t,n){if(!t||!n||0===n.length)return t;let e=t;return[...n].sort((t,n)=>n.length-t.length).forEach(t=>{const n=function(t){if(!t||"null"===t||"undefined"===t||""===t.trim())return"#95a5a6";if(E.has(t))return E.get(t);let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n&=n;const e=Math.abs(n)%a.length,i=a[e];return E.set(t,i),i}(t),i=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`\\b${i}\\b`,"gi"),r=t&&"null"!==t&&"undefined"!==t&&""!==t.trim()?"username-color-coded":"username-color-coded anonymous";e=e.replace(o,t=>`<span class="${r}" style="color: ${n}; font-weight: 600;">${t}</span>`)}),e}(n.reviewSummary,g);u+='<div class="summary-toggle collapsed" data-target="review-summary">',u+="<span>Review Summary</span>",u+=`<span class="${i.iconClass} toggle-icon">${i.expandIcon}</span>`,u+="</div>",u+='<div class="summary-content" id="review-summary">',u+=`<p>${p}</p>`,u+="</div>",u+='<div class="assessment-section">',u+=`<strong>Overall Assessment:</strong> <span class="assessment-rating ${t}">${n.assessment}</span><br><hr style="margin: 5px 0;">`,u+=`<strong>Analysis Summary:</strong> ${n.summary}<br><hr style="margin: 5px 0;">`,n.characterDevelopment&&(u+=`<strong>Character Development:</strong> <span class="assessment-rating ${e}">${"Unknown"===n.characterDevelopment?"Insufficient Data":n.characterDevelopment}</span><br>`),n.plotStructure&&(u+=`<strong>Plot Structure:</strong> <span class="assessment-rating ${o}">${"Unknown"===n.plotStructure?"Insufficient Data":n.plotStructure}</span><br>`),n.worldBuilding&&(u+=`<strong>World-Building:</strong> <span class="assessment-rating ${l}">${"Unknown"===n.worldBuilding?"Insufficient Data":n.worldBuilding}</span><br>`),n.themesAndMessages&&(u+=`<strong>Themes & Messages:</strong> <span class="assessment-rating ${c}">${"Unknown"===n.themesAndMessages?"Insufficient Data":n.themesAndMessages}</span><br>`),n.writingStyle&&(u+=`<strong>Writing Style:</strong> <span class="assessment-rating ${d}">${"Unknown"===n.writingStyle?"Insufficient Data":n.writingStyle}</span><br>`),n.unknown&&"Mixed"!==n.unknown&&(u+=`<strong>Legacy Unknown Data:</strong> <span class="assessment-rating ${m}">${n.unknown}</span><br>`),u+="</div>",r.innerHTML=`\n\t\t\t<div class="gemini-summary-card">\n\t\t\t\t${u}\n\t\t\t</div>\n\t\t`,s=r.querySelector(".gemini-summary-card")}const f=t.querySelector(".title-wrap"),h=document.createElement("div");h.className="gemini-summary-trigger",p.size>0?h.title=e?"Show AI Summary":"Analyze Novel":(h.classList.add("disabled"),h.title="Initialization Failed - Refresh Page"),h.innerHTML=`<span class="${i.iconClass}">${i.autoAwesomeIcon}</span>`;let y=!1;if(h.addEventListener("click",async function(n){if(n.stopPropagation(),h.classList.contains("disabled"))alert("The reviewer failed to initialize correctly. Please refresh the page to get correct data.");else if(e)y=!y,y?s.classList.add("locked"):s.classList.remove("locked");else try{await async function(t){if(!m()&&!await new Promise(t=>{document.getElementById("gemini-api-key-modal-input").value="",document.getElementById("gemini-api-key-modal").style.display="block";const n=document.getElementById("gemini-api-key-modal-save"),e=document.getElementById("gemini-api-key-modal-close");n.addEventListener("click",()=>{const n=document.getElementById("gemini-api-key-modal-input").value.trim();n?(c({...d(),apiKey:n}),document.getElementById("gemini-api-key-modal").style.display="none",t(!0)):alert("Please enter a valid API key.")},{once:!0}),e.addEventListener("click",()=>{document.getElementById("gemini-api-key-modal").style.display="none",t(!1)},{once:!0})}))return;if(0===p.size)return console.error("PROCESSING HALTED: Serie ID map is empty. Cannot proceed with invalid mappings."),u("Processing aborted: Serie ID map validation failed (empty map)"),void w();const n=t.querySelector("a.title");let e=null,i=null;const a=window.location.href;if(n)if(a.includes("wtr-lab.com/en/novel-finder")){const t=n.href.match(/\/novel\/(\d+)\//);t&&t[1]&&(i=t[1],e=b(i))}else i=n.dataset.novelId,i&&(e=b(i));if(e&&!function(t,n){return n&&null!=n&&""!==n?/^\d+$/.test(n.toString())?(u(`Mapping validation SUCCESS: raw_id ${t} -> serie_id ${n}`),!0):(u(`Mapping validation FAILED: Invalid serie_id format "${n}" for raw_id ${t}`),!1):(u(`Mapping validation FAILED: Invalid serie_id for raw_id ${t}`),!1)}(i,e))return console.error(`PROCESSING HALTED: Invalid serie_id mapping detected for raw_id ${i}`),u(`Processing aborted: Mapping validation failed for raw_id ${i}`),void w();if(!e)return console.warn("No serie_id mapping found for card. Cannot process this novel."),void u("Cannot process novel: No mapping in serieIdMap");if(e&&k(e))return void u(`Novel with serie_id ${e} is already cached - no processing needed`);const r=[t],s=r.map(t=>function(t){const n=document.createElement("div");n.className="gemini-processing-overlay",n.textContent="Analyzing...";const e=t.querySelector(".card-body");return e&&(e.style.position="relative",e.appendChild(n)),n}(t));try{const t=await async function(t,n){const e=[],i=[];for(let o=0;o<t.length;o++){const a=t[o],r=n[o];let s,l,c;if(window.location.href.includes("wtr-lab.com/en/novel-finder")){if(s=C(a),!s){console.warn("Skipping card, failed to parse novel-finder card.",a);continue}c=s.raw_id,l=b(c)}else{if(c=a.querySelector("a.title").dataset.novelId,l=b(c),!l)throw console.error("PROCESSING HALTED: Unable to obtain valid serie_id"),w(),n.forEach(t=>t&&t.remove()),new Error("No valid serie_id available");const t=a.querySelector("a.title");let e=t?t.textContent.trim():"No title";t&&e.startsWith("#")&&(e=e.split(" ").slice(1).join(" "));const i=t?t.querySelector(".rawtitle"):null;i&&(e=e.replace(i.textContent,"").trim());const o=a.querySelector(".detail-buttons .detail-line:nth-of-type(1)");let r=0;if(o){const t=o.textContent.match(/(\d+) views/);t&&(r=parseInt(t[1],10))}const d=a.querySelector(".detail-buttons .detail-line:nth-of-type(2)");let m=0;if(d){const t=d.textContent.match(/(\d+) Readers/);t&&(m=parseInt(t[1],10))}const g=a.querySelector(".rating-text");let u=0;if(g){const t=g.textContent.match(/(\d+\.\d+)/);t&&(u=parseFloat(t[1]))}const p=a.querySelectorAll(".genres .genre");s={serie_id:l,raw_id:c,title:e,totalViews:r,totalReaders:m,rating:u,genres:Array.from(p).map(t=>t.textContent.trim()),description:a.querySelector(".description")?.textContent.trim()||"No description."}}const d=(await T(l)).filter(t=>t.comment),m=d.map(t=>`- User: ${t.username||"Unknown"}\n- Rating: ${t.rate}/5\n- Comment: ${t.comment}`).join("\n\n"),u=I(d);e.push({...s,reviewsText:m,availableUsernames:u}),i.push({card:a,overlay:r,serieId:l}),await g(300)}if(0===e.length)return{batchResults:i,novelsData:[]};const a=await function(t){const n=`\n\t              Analyze the following list of novels. For each novel, use its title, view count, reader count, rating, genres, description, and user reviews to provide a comprehensive assessment across multiple categories.\n\t              Return a single JSON array. Each object in the array must correspond to a novel in the input list, maintaining the original order.\n\n\t              For each novel, provide:\n\t              1. A novel summary: A concise 2-3 sentence summary of what the novel is about, based primarily on the title, description, genres, and user reviews.\n\t              2. A review summary: A balanced summary of user feedback from the reviews, including positive and negative points, with proper attribution to usernames (e.g., "According to [User], ..."). Use EXACT usernames from the availableUsernames list when making attributions.\n\n\t              Then provide detailed assessments in the following categories:\n\t              - Overall assessment (Good/Mixed/Bad)\n\t              - Character Development (Good/Mixed/Bad/Unknown)\n\t              - Plot Structure (Good/Mixed/Bad/Unknown)\n\t              - World-Building (Good/Mixed/Bad/Unknown)\n\t              - Themes & Messages (Good/Mixed/Bad/Unknown)\n\t              - Writing Style (Good/Mixed/Bad/Unknown)\n\n\t              For each category, include specific criteria:\n\t              - Character Development: character depth, growth, consistency, dialogue authenticity, relationship dynamics\n\t              - Plot Structure: pacing, narrative flow, story coherence, conflict resolution, foreshadowing\n\t              - World-Building: setting details, consistency, immersion, cultural depth, originality\n\t              - Themes & Messages: clarity, relevance, integration, thought provocation, balance\n\t              - Writing Style: prose quality, descriptive language, dialogue naturalness, grammar, technical execution\n\n\t              CRITICAL: Each category can be rated as "Unknown" when:\n\t              - Character Development: No character development information found in available data\n\t              - Plot Structure: No plot structure information found in available data\n\t              - World-Building: No world-building details found in available data\n\t              - Themes & Messages: No theme or message information found in available data\n\t              - Writing Style: No writing style information found in available data\n\n\t              Important distinctions:\n\t              - "Unknown" means: insufficient data to make a reliable assessment for that specific aspect\n\t              - "Bad" means: poor quality or problematic implementation of that aspect\n\t              - Use "Unknown" when data is genuinely missing or insufficient, NOT when quality is poor\n\n\t              Novels List:\n\t              ${JSON.stringify(t,null,2)}\n\t      `,e=JSON.stringify({contents:[{parts:[{text:n}]}],generationConfig:{responseMimeType:"application/json",responseJsonSchema:{type:"array",items:{type:"object",properties:{novelSummary:{type:"string",description:"A concise 2-3 sentence summary of what the novel is about."},reviewSummary:{type:"string",description:"A balanced summary of user feedback with proper username attribution."},assessment:{type:"string",enum:["Good","Mixed","Bad"]},summary:{type:"string",description:"A brief 2-3 sentence summary explaining the overall assessment."},characterDevelopment:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},plotStructure:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},worldBuilding:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},themesAndMessages:{type:"string",enum:["Good","Mixed","Bad","Unknown"]},writingStyle:{type:"string",enum:["Good","Mixed","Bad","Unknown"]}},required:["novelSummary","reviewSummary","assessment","summary","characterDevelopment","plotStructure","worldBuilding","themesAndMessages","writingStyle"]}},temperature:.3},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]});return u("Gemini Prompt:",n),new Promise((t,n)=>{let i=0;const a=()=>{const r=m(),s=l.geminiModel;GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/models/${s}:generateContent?key=${r}`,headers:{"Content-Type":"application/json"},data:e,onload:function(e){try{const r=JSON.parse(e.responseText);if(u("Gemini Raw Response:",r),r.candidates&&r.candidates.length>0){const n=JSON.parse(r.candidates[0].content.parts[0].text);t(n)}else{const t=r.promptFeedback?`Gemini block reason: ${JSON.stringify(r.promptFeedback)}`:"Gemini API returned no candidates.";if(console.error("Gemini API Response Error:",r),i<3){i++;const n=o*Math.pow(2,i-1);console.warn(`Retrying Gemini request in ${n}ms (Attempt ${i}/3). Error: ${t}`),setTimeout(a,n)}else n(`Gemini API failed after 3 retries. Last error: ${t}`)}}catch(t){if(i<3){i++;const n=o*Math.pow(2,i-1);console.warn(`Retrying Gemini request in ${n}ms (Attempt ${i}/3). Error: Failed to parse response: ${t}`),setTimeout(a,n)}else n(`Failed to parse Gemini response after 3 retries: ${t}\nResponse: ${e.responseText}`)}},onerror:t=>{if(i<3){i++;const n=o*Math.pow(2,i-1);console.warn(`Retrying Gemini request in ${n}ms (Attempt ${i}/3). Error: API request failed: ${t.statusText}`),setTimeout(a,n)}else n(`Gemini API request failed after 3 retries: ${t.statusText}`)}})};a()})}(e);if(a.length!==e.length)throw new Error("Mismatch between number of novels sent and analyses received.");return i.forEach(({card:t,overlay:n,serieId:i},o)=>{let r=a[o];const s=e[o];r&&(!r.availableUsernames&&s&&s.availableUsernames&&(r.availableUsernames=s.availableUsernames),r=M(r),$(t,r),function(t,n){if(x())try{const e=A(t);localStorage.setItem(e,JSON.stringify(n))}catch(n){"QuotaExceededError"===n.name?console.warn("Local storage quota exceeded, unable to cache assessment for serieId:",t):console.warn("Error caching assessment for serieId:",t,n)}}(i,r),t.dataset.geminiProcessed="true"),n&&n.remove()}),{batchResults:i,novelsData:e}}(r,s);0===t.novelsData.length&&u("Novel was cached - no API call needed")}catch(t){console.error("An error occurred during specific novel processing:",t),s.forEach(t=>{t&&(t.textContent="Processing Failed",setTimeout(()=>t.remove(),4e3))})}}(t)}catch(t){console.error("Error processing specific novel:",t)}}),e){const t=s.querySelector(".mobile-close-btn");if(t){const n=t=>{"touchstart"===t.type&&t.preventDefault(),t.stopPropagation(),s.classList.remove("locked"),y=!1};t.addEventListener("click",n),t.addEventListener("touchstart",n,{passive:!1})}s.querySelectorAll(".summary-toggle").forEach(t=>{t.addEventListener("click",function(){const t=this.dataset.target,n=s.querySelector(`#${t}`);this.classList.contains("collapsed")?(this.classList.remove("collapsed"),n.classList.add("expanded")):(this.classList.add("collapsed"),n.classList.remove("expanded"))})})}f&&f.appendChild(h),t.appendChild(r)}function C(t){const n=t.querySelector(".title-wrap .title"),e=t.querySelector(".rawtitle"),i=t.querySelector(".title-wrap a"),o=t.querySelector("picture source[srcset]"),a=t.querySelectorAll(".detail-line"),r=Array.from(t.querySelectorAll(".genres .genre")).map(t=>t.textContent.trim()),s=t.querySelector(".desc-wrap .description");if(!n||!i)return null;const l=i.href,c=l.match(/\/novel\/(\d+)\//);if(!c||!c[1])return null;const d=c[1],m=c[1];let g="Unknown",u="0",p="0",f="0";if(a.length>0){const t=a[0].textContent.trim(),n=t.match(/•\s*(\w+)/);n&&n[1]&&(g=n[1]);const e=t.match(/·\s*([\d,]+)\s*views/i);e&&e[1]&&(u=e[1].replace(/,/g,""))}if(a.length>1){const t=a[1].textContent.trim(),n=t.match(/([\d,]+)\s*Chapters/i);n&&n[1]&&(p=n[1].replace(/,/g,""));const e=t.match(/·\s*([\d,]+)\s*Readers/i);e&&e[1]&&(f=e[1].replace(/,/g,""))}return{serie_id:m,raw_id:d,title:n.firstChild.textContent.trim(),raw_title:e?e.textContent.trim():"",url:l,cover_url:o?o.srcset.split(" ")[0]:"",status:g,views:parseInt(u,10),chapters:parseInt(p,10),readers:parseInt(f,10),genres:r,description:s?s.textContent.trim():""}}function M(t){return t.unknown||(t.unknown="Mixed"),t}async function T(t){let n=[];const e=`https://wtr-lab.com/api/review/get?serie_id=${t}&page=0&sort=most_liked`;u(`Fetching reviews for serieId ${t}, Page 0 from: ${e}`);try{const i=await fetch(e);if(!i.ok)return u(`Review API response not OK for ${t}. Status: ${i.status}`),[];const o=await i.json();if(u(`Review API raw data for ${t}, Page 0:`,o),!(o.success&&o.data&&o.data.length>0))return u(`No reviews found in page 0 for ${t}`),[];{n=n.concat(o.data),u(`Page 0 received ${o.data.length} reviews for ${t}`);const e=o.data.filter(t=>t.comment);if(e.length>=3)return u(`Page 0 has sufficient data (${e.length} reviews with comments) for ${t} - stopping here`),n}}catch(n){return console.error(`Error fetching reviews for serie_id ${t} on page 0:`,n),[]}for(let e=1;e<5;e++){const i=`https://wtr-lab.com/api/review/get?serie_id=${t}&page=${e}&sort=most_liked`;u(`Fetching reviews for serieId ${t}, Page ${e} from: ${i}`);try{const o=await fetch(i);if(!o.ok){u(`Review API response not OK for ${t}. Status: ${o.status}`);break}const a=await o.json();if(u(`Review API raw data for ${t}, Page ${e}:`,a),!(a.success&&a.data&&a.data.length>0))break;n=n.concat(a.data)}catch(n){console.error(`Error fetching reviews for serie_id ${t} on page ${e}:`,n);break}await g(100)}return n}function L(){const t=window.location.href,n=t.includes("wtr-lab.com/en/novel-finder")?".card:not([data-gemini-processed]):not([data-gemini-cached-checked])":".series-list > .card:not([data-gemini-processed]):not([data-gemini-cached-checked])";Array.from(document.querySelectorAll(n)).forEach(n=>{const e=n.querySelector("a.title");let i=null,o=null;if(e)if(t.includes("wtr-lab.com/en/novel-finder")){const t=e.href.match(/\/novel\/(\d+)\//);t&&t[1]&&(o=t[1],i=b(o))}else o=e.dataset.novelId,o&&(i=b(o));let a=null;i&&(a=k(i),a&&(a.availableUsernames||(a.availableUsernames=[]),a=M(a))),$(n,a),n.dataset.geminiCachedChecked="true"})}const P=history.pushState,N=history.replaceState;var R=e(72),G=e.n(R),U=e(825),D=e.n(U),B=e(659),O=e.n(B),z=e(56),q=e.n(z),j=e(540),F=e.n(j),K=e(113),H=e.n(K),W=e(483),J={};J.styleTagTransform=H(),J.setAttributes=q(),J.insert=O().bind(null,"head"),J.domAPI=D(),J.insertStyleElement=F(),G()(W.A,J),W.A&&W.A.locals&&W.A.locals;var V=e(229),X={};X.styleTagTransform=H(),X.setAttributes=q(),X.insert=O().bind(null,"head"),X.domAPI=D(),X.insertStyleElement=F(),G()(V.A,X),V.A&&V.A.locals&&V.A.locals;var Y=e(933),Q={};Q.styleTagTransform=H(),Q.setAttributes=q(),Q.insert=O().bind(null,"head"),Q.domAPI=D(),Q.insertStyleElement=F(),G()(Y.A,Q),Y.A&&Y.A.locals&&Y.A.locals;var Z=e(193),tt={};tt.styleTagTransform=H(),tt.setAttributes=q(),tt.insert=O().bind(null,"head"),tt.domAPI=D(),tt.insertStyleElement=F(),G()(Z.A,tt),Z.A&&Z.A.locals&&Z.A.locals;var nt=e(355),et={};et.styleTagTransform=H(),et.setAttributes=q(),et.insert=O().bind(null,"head"),et.domAPI=D(),et.insertStyleElement=F(),G()(nt.A,et),nt.A&&nt.A.locals&&nt.A.locals;var it=e(731),ot={};ot.styleTagTransform=H(),ot.setAttributes=q(),ot.insert=O().bind(null,"head"),ot.domAPI=D(),ot.insertStyleElement=F(),G()(it.A,ot),it.A&&it.A.locals&&it.A.locals;var at=e(532),rt={};rt.styleTagTransform=H(),rt.setAttributes=q(),rt.insert=O().bind(null,"head"),rt.domAPI=D(),rt.insertStyleElement=F(),G()(at.A,rt),at.A&&at.A.locals&&at.A.locals;var st=e(538),lt={};lt.styleTagTransform=H(),lt.setAttributes=q(),lt.insert=O().bind(null,"head"),lt.domAPI=D(),lt.insertStyleElement=F(),G()(st.A,lt),st.A&&st.A.locals&&st.A.locals;var ct=e(279),dt={};dt.styleTagTransform=H(),dt.setAttributes=q(),dt.insert=O().bind(null,"head"),dt.domAPI=D(),dt.insertStyleElement=F(),G()(ct.A,dt),ct.A&&ct.A.locals&&ct.A.locals;var mt=e(41),gt={};gt.styleTagTransform=H(),gt.setAttributes=q(),gt.insert=O().bind(null,"head"),gt.domAPI=D(),gt.insertStyleElement=F(),G()(mt.A,gt),mt.A&&mt.A.locals&&mt.A.locals;const ut=[/^https:\/\/wtr-lab\.com\/en\/for-you/,/^https:\/\/wtr-lab\.com\/en\/novel-finder/];let pt=null,ft=null;async function ht(){u("Initializing view context..."),v(),await async function(){for(let t=1;t<=3;t++){if(u(`Attempting to build serie_id map (Attempt ${t}/3)`),await h())return u("Serie ID mapping validation: SUCCESS"),!0;console.warn(`Serie ID mapping failed on attempt ${t}/3`),t<3&&(u("Retrying in 2000ms..."),await g(2e3))}return console.error("Serie ID mapping validation: FAILED after all retry attempts"),!1}()?L():(console.warn("View initialization: Unable to build/update serie_id mapping"),w())}function yt(t){return ut.some(n=>n.test(t))}async function bt(t){pt&&clearTimeout(pt),pt=setTimeout(async()=>{if(u(`Processing route change for: ${t}`),!yt(t))return void u("[WTR-Lab] Unsupported route. Going idle.");const n=await async function(t){try{const n=document.querySelector('script[id="__NEXT_DATA__"]');if(!n)return!1;const e=JSON.parse(n.textContent).buildId;if(!e)return!1;const i=new URL(t);let o=i.pathname;o.length>1&&o.endsWith("/")&&(o=o.slice(0,-1));const a=`/_next/data/${e}${o}.json${i.search}`;u(`Fetching data mapping from: ${a}`);const r=await fetch(a);if(!r.ok)return!1;const s=await r.json();if(s&&s.pageProps)return y(s.pageProps),u(`Updated map from fetch. Size: ${p.size}`),!0}catch(t){console.error("Error fetching Next.js data:",t)}return!1}(t);n?(v(),L()):await ht()},500)}async function vt(){u("WTR-Lab Novel Reviewer starting..."),l.apiKey=GM_getValue("geminiApiKey",""),GM_getValue("batchLimit","1"),l.geminiModel=GM_getValue("geminiModel",r),l.debugLoggingEnabled=GM_getValue("debugLoggingEnabled",s),function(){if(document.getElementById("gemini-settings-panel"))return;const t=`\n\t<div id="gemini-settings-panel">\n\t\t<h3>Gemini Reviewer Settings</h3>\n\t\t<label for="gemini-api-key-input">Gemini API Key:</label>\n\t\t<input type="password" id="gemini-api-key-input">\n\t\t<label for="gemini-model-select">Gemini Model:</label>\n\t\t<select id="gemini-model-select">${i.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>\n\t\t<label for="gemini-debug-logging-input" class="debug-logging-label">\n\t\t\t<input type="checkbox" id="gemini-debug-logging-input">\n\t\t\tEnable Debug Logging (Logs prompts and responses)\n\t\t</label>\n\t\t<div class="buttons">\n\t\t\t<button id="clear-cache-button" class="clear-cache-btn">Clear Analyzed Novel Cache</button>\n\t\t\t<button id="gemini-settings-close">Close</button>\n\t\t\t<button id="gemini-settings-save">Save</button>\n\t\t</div>\n\t</div>\n`;document.body.insertAdjacentHTML("beforeend",t)}(),document.getElementById("gemini-api-key-modal")||document.body.insertAdjacentHTML("beforeend",'\n\t\t<div id="gemini-api-key-modal">\n\t\t\t<h3>How to Get Your FREE Gemini API Token</h3>\n\t\t\t<div class="instructions">\n\t\t\t\t<ol>\n\t\t\t\t\t<li>Go to <a href="https://aistudio.google.com/" target="_blank" style="color: #0d6efd;">Google AI Studio</a></li>\n\t\t\t\t\t<li>Sign in with your Google account</li>\n\t\t\t\t\t<li>Click "Get API key in Google AI Studio"</li>\n\t\t\t\t\t<li>Create a new API key or use an existing one</li>\n\t\t\t\t\t<li>Copy the API key and paste it below</li>\n\t\t\t\t</ol>\n\t\t\t</div>\n\t\t\t<label for="gemini-api-key-modal-input">Gemini API Key:</label>\n\t\t\t<input type="password" id="gemini-api-key-modal-input" placeholder="Enter your Gemini API key here">\n\t\t\t<div class="buttons">\n\t\t\t\t<button id="gemini-api-key-modal-close">Cancel</button>\n\t\t\t\t<button id="gemini-api-key-modal-save">Save & Continue</button>\n\t\t\t</div>\n\t\t</div>\n\t'),S||(S=!0,GM_registerMenuCommand("Open Settings",()=>{const t=d();document.getElementById("gemini-api-key-input").value=t.apiKey,document.getElementById("gemini-model-select").value=t.geminiModel,document.getElementById("gemini-debug-logging-input").checked=t.debugLoggingEnabled,document.getElementById("gemini-settings-panel").style.display="block"}),document.getElementById("gemini-settings-save").addEventListener("click",()=>{c({apiKey:document.getElementById("gemini-api-key-input").value,geminiModel:document.getElementById("gemini-model-select").value,debugLoggingEnabled:document.getElementById("gemini-debug-logging-input").checked}),alert("Settings saved."),document.getElementById("gemini-settings-panel").style.display="none"}),document.getElementById("gemini-settings-close").addEventListener("click",()=>{document.getElementById("gemini-settings-panel").style.display="none"}),document.getElementById("clear-cache-button").addEventListener("click",()=>{confirm("Are you sure you want to clear the cache for all analyzed novels? This action cannot be undone.")&&(function(){if(!x())return!1;try{const t="geminiAssessment_";let n=0,e=0;const i=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&i.push(n)}for(const o of i)if(o.startsWith(t))try{localStorage.removeItem(o),n++}catch(t){console.warn("Error removing cached assessment key:",o,t),e++}return console.log(`Cleared ${n} cached assessments from localStorage`),e>0&&console.warn(`Encountered ${e} errors while clearing cached assessments`),0===e}catch(t){return console.warn("Error clearing all cached assessments:",t),!1}}()?(alert("Cache cleared successfully. Refreshing page..."),window.location.reload()):alert("Failed to clear cache. Check console for details."))})),function(t){u("Setting up route change listener");let n=null;const e=()=>{const e=window.location.href;u(`Route change detected (raw): ${e}`),n&&clearTimeout(n),n=setTimeout(()=>{u(`Route change processed (debounced): ${e}`),t(e)},500)};window.addEventListener("popstate",e),history.pushState=function(...t){const n=P.apply(this,t);return e(),n},history.replaceState=function(...t){const n=N.apply(this,t);return e(),n};let i=window.location.href;setInterval(()=>{const t=window.location.href;t!==i&&(i=t,e())},1e3),u("Route change listener active")}(bt),await ht(),ft&&ft.disconnect(),ft=new MutationObserver(t=>{yt(window.location.href)&&t.some(t=>t.addedNodes.length>0&&(t.target.classList?.contains("series-list")||document.querySelector(".series-list")||document.querySelector(".card")))&&L()}),ft.observe(document.body,{childList:!0,subtree:!0}),u("MutationObserver started")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",vt):vt()})();